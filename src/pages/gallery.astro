---
import BaseLayout from '../layouts/BaseLayout.astro';
import SectionTitle from '../components/SectionTitle.astro';
import fs from 'node:fs';
import path from 'node:path';

const galleryDir = path.join(process.cwd(), 'public/images/gallery');
const exts = new Set(['.jpg', '.jpeg', '.png', '.webp']);
const images = fs.existsSync(galleryDir)
  ? fs.readdirSync(galleryDir)
      .filter((f) => exts.has(path.extname(f).toLowerCase()))
      .sort()
      .map((f) => `/images/gallery/${f}`)
  : [];
---

<BaseLayout title="Gallery" description="ギャラリー・宣材写真">
  <section class="max-w-5xl mx-auto px-4 py-20">
    <SectionTitle title="Gallery" subtitle="ギャラリー" />

    {images.length > 0 ? (
      <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
        {images.map((src) => (
          <div class="h-64 md:h-80 bg-stone-100 flex items-center justify-center cursor-pointer" data-lightbox-trigger>
            <img
              src={`${src}`}
              alt=""
              class="max-w-full max-h-full object-contain"
              loading="lazy"
            />
          </div>
        ))}
      </div>
    ) : (
      <div class="text-center py-20">
        <p class="text-stone-400">写真は準備中です。</p>
      </div>
    )}
  </section>

  <!-- Lightbox -->
  <div id="lightbox" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 cursor-pointer">
    <img id="lightbox-img" src="" alt="" class="max-w-[90vw] max-h-[90vh] object-contain" />
  </div>

  <script>
    const lightbox = document.getElementById('lightbox')!;
    const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;

    document.querySelectorAll('[data-lightbox-trigger]').forEach((el) => {
      el.addEventListener('click', () => {
        const img = el.querySelector('img');
        if (!img) return;
        lightboxImg.src = img.src;
        lightboxImg.alt = img.alt;
        lightbox.classList.remove('hidden');
        lightbox.classList.add('flex');
      });
    });

    lightbox.addEventListener('click', () => {
      lightbox.classList.add('hidden');
      lightbox.classList.remove('flex');
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !lightbox.classList.contains('hidden')) {
        lightbox.classList.add('hidden');
        lightbox.classList.remove('flex');
      }
    });
  </script>
</BaseLayout>
